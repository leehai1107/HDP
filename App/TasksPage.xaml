<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="App.TasksPage"
             Title="Tasks"
             BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="{Binding CurrentUsername}" Order="Secondary"/>
        <ToolbarItem Text="Logout" Clicked="OnLogoutClicked" Order="Secondary"/>
    </ContentPage.ToolbarItems>
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:TaskTextDecorationConverter x:Key="TaskTextDecorationConverter"
                                                    xmlns:converters="clr-namespace:App.Converters"/>
            <converters:StringIsNotNullOrEmptyConverter x:Key="StringIsNotNullOrEmptyConverter"
                                                       xmlns:converters="clr-namespace:App.Converters"/>
            <converters:CountIsZeroConverter x:Key="CountIsZeroConverter"
                                             xmlns:converters="clr-namespace:App.Converters"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*" Padding="16" RowSpacing="16">

        <!-- Simple Tab Buttons -->
        <HorizontalStackLayout Grid.Row="0" Spacing="8">
            <Button Text="{Binding ActiveTasksCount, StringFormat='Active ({0})'}"
                    Command="{Binding SwitchToActiveTabCommand}"
                    FontSize="14"
                    Padding="16,10"
                    CornerRadius="20">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding TaskFilterMode}" Value="Active">
                        <Setter Property="BackgroundColor" Value="#007ACC"/>
                        <Setter Property="TextColor" Value="White"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding TaskFilterMode}" Value="Done">
                        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#E0E0E0, Dark=#2A2A2A}"/>
                        <Setter Property="TextColor" Value="{AppThemeBinding Light=#666, Dark=#999}"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
            
            <Button Text="{Binding DoneTasksCount, StringFormat='Done ({0})'}"
                    Command="{Binding SwitchToDoneTabCommand}"
                    FontSize="14"
                    Padding="16,10"
                    CornerRadius="20">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding TaskFilterMode}" Value="Done">
                        <Setter Property="BackgroundColor" Value="#4CAF50"/>
                        <Setter Property="TextColor" Value="White"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding TaskFilterMode}" Value="Active">
                        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#E0E0E0, Dark=#2A2A2A}"/>
                        <Setter Property="TextColor" Value="{AppThemeBinding Light=#666, Dark=#999}"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
        </HorizontalStackLayout>

        <!-- Search and Sort Combined -->
        <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="8">
            <Entry Grid.Column="0"
                   Placeholder="Search..."
                   Text="{Binding TaskSearchQuery}"
                   PlaceholderColor="{AppThemeBinding Light=#999, Dark=#666}"
                   TextColor="{AppThemeBinding Light=#000, Dark=#FFF}"
                   BackgroundColor="{AppThemeBinding Light=#FFF, Dark=#1E1E1E}"
                   FontSize="14"/>
            <Picker Grid.Column="1"
                    SelectedItem="{Binding TaskSortMode}"
                    FontSize="14"
                    WidthRequest="140"
                    BackgroundColor="{AppThemeBinding Light=#FFF, Dark=#1E1E1E}"
                    TextColor="{AppThemeBinding Light=#000, Dark=#FFF}">
                <Picker.Items>
                    <x:String>None</x:String>
                    <x:String>DaysAscending</x:String>
                    <x:String>DaysDescending</x:String>
                </Picker.Items>
            </Picker>
        </Grid>

        <!-- Tasks List -->
        <CollectionView Grid.Row="2" ItemsSource="{Binding FilteredTasks}" SelectionMode="None">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <SwipeView Margin="0,0,0,8">
                        <SwipeView.RightItems>
                            <SwipeItems>
                                <SwipeItem Text="Delete"
                                           BackgroundColor="#F44336"
                                           Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTaskCommand}"
                                           CommandParameter="{Binding .}"/>
                            </SwipeItems>
                        </SwipeView.RightItems>
                        
                        <Border BackgroundColor="{AppThemeBinding Light=#FFF, Dark=#1E1E1E}"
                                StrokeThickness="0"
                                Padding="14,10">
                            <Border.Shadow>
                                <Shadow Brush="Black" Opacity="0.1" Radius="8" Offset="0,2"/>
                            </Border.Shadow>
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal" />
                                    <VisualState Name="PointerOver">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#F0F8FF, Dark=#2A3F5F}"/>
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            
                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="6">
                                <!-- Checkbox -->
                                <CheckBox Grid.Row="0" Grid.Column="0" Grid.RowSpan="2"
                                          IsChecked="{Binding IsDone}"
                                          VerticalOptions="Center"
                                          CheckedChanged="OnTaskCheckBoxChanged"/>
                                
                                <!-- Task Name (Click to Edit) -->
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding Name}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextDecorations="{Binding IsDone, Converter={StaticResource TaskTextDecorationConverter}}"
                                       TextColor="{AppThemeBinding Light=#000, Dark=#FFF}"
                                       LineBreakMode="WordWrap">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer NumberOfTapsRequired="2" Tapped="OnNameDoubleTapped"/>
                                    </Label.GestureRecognizers>
                                </Label>
                                
                                <!-- Description -->
                                <Label Grid.Row="1" Grid.Column="1"
                                       Text="{Binding Description}"
                                       FontSize="15"
                                       TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                                       LineBreakMode="WordWrap"
                                       IsVisible="{Binding Description, Converter={StaticResource StringIsNotNullOrEmptyConverter}}">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer NumberOfTapsRequired="2" Tapped="OnDescriptionDoubleTapped"/>
                                    </Label.GestureRecognizers>
                                </Label>
                                
                                <!-- Due Date & Status -->
                                <HorizontalStackLayout Grid.Row="2" Grid.Column="1" Spacing="12">
                                    <Label FontSize="12" TextColor="{AppThemeBinding Light=#999, Dark=#888}">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer NumberOfTapsRequired="2" Tapped="OnDateDoubleTapped"/>
                                        </Label.GestureRecognizers>
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="ðŸ“… "/>
                                                <Span Text="{Binding EndDate, StringFormat='{0:MMM dd}'}"/>
                                                <Span Text=" â€¢ "/>
                                                <Span Text="{Binding RemainingDays}"/>
                                                <Span Text="d left"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                    <Label FontSize="12" TextColor="#4CAF50">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer NumberOfTapsRequired="2" Tapped="OnStatusDoubleTapped"/>
                                        </Label.GestureRecognizers>
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="ðŸ“Š "/>
                                                <Span Text="{Binding Status}" FontAttributes="Bold"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                    <Label FontSize="12" 
                                           TextColor="#2196F3"
                                           IsVisible="{Binding AssignedTo, Converter={StaticResource StringIsNotNullOrEmptyConverter}}">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="ðŸ‘¤ "/>
                                                <Span Text="{Binding AssignedTo}" FontAttributes="Bold"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </HorizontalStackLayout>
                                
                                <!-- Attachment Path -->
                                <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"
                                      ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8"
                                      IsVisible="{Binding AttachmentPath, Converter={StaticResource StringIsNotNullOrEmptyConverter}}">
                                    <Label Grid.Column="0"
                                           Text="{Binding AttachmentPath}"
                                           FontSize="13"
                                           TextColor="{AppThemeBinding Light=#888, Dark=#999}"
                                           LineBreakMode="TailTruncation"
                                           VerticalTextAlignment="Center"/>
                                    <Button Grid.Column="1"
                                            Text="ðŸ“‹ Copy"
                                            Clicked="OnCopyPathClicked"
                                            BackgroundColor="#2196F3"
                                            TextColor="White"
                                            Padding="10,6"
                                            FontSize="12"
                                            CornerRadius="6"/>
                                    <Button Grid.Column="2"
                                            Text="ðŸ“ Open"
                                            Clicked="OnOpenFolderClicked"
                                            BackgroundColor="#4CAF50"
                                            TextColor="White"
                                            Padding="10,6"
                                            FontSize="12"
                                            CornerRadius="6"/>
                                </Grid>
                                
                                <!-- Edit Hint -->
                                <Label Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2"
                                       Text="ðŸ’¡ Double-tap fields to edit"
                                       FontSize="11"
                                       TextColor="{AppThemeBinding Light=#BBB, Dark=#666}"
                                       HorizontalTextAlignment="Center"
                                       Margin="0,6,0,0"/>
                            </Grid>
                        </Border>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Empty State -->
        <Label Grid.Row="2"
               Text="No tasks yet"
               FontSize="16"
               TextColor="{AppThemeBinding Light=#999, Dark=#666}"
               HorizontalTextAlignment="Center"
               VerticalTextAlignment="Center"
               IsVisible="{Binding Tasks, Converter={StaticResource CountIsZeroConverter}}"/>
    </Grid>
</ContentPage>
