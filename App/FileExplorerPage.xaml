<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="App.FileExplorerPage"
             Title="File Explorer"
             BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:IntToBoolConverter x:Key="IntToBoolConverter"
                                           xmlns:converters="clr-namespace:App.Converters"/>
            <converters:SelectionModeConverter x:Key="SelectionModeConverter"
                                               xmlns:converters="clr-namespace:App.Converters"/>
            <converters:SelectionModeColorConverter x:Key="SelectionModeColorConverter"
                                                    xmlns:converters="clr-namespace:App.Converters"/>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter"
                                             xmlns:converters="clr-namespace:App.Converters"/>
            <converters:TaskTextDecorationConverter x:Key="TaskTextDecorationConverter"
                                                    xmlns:converters="clr-namespace:App.Converters"/>
            <converters:TaskOpacityConverter x:Key="TaskOpacityConverter"
                                             xmlns:converters="clr-namespace:App.Converters"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Main Layout: Task Panel (Left) + File Explorer (Right) -->
    <Grid ColumnDefinitions="300,*"
          ColumnSpacing="0">

        <!-- Task Panel (Left Side) -->
        <Grid Grid.Column="0"
              RowDefinitions="Auto,*"
              BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}">

            <!-- Task Creation Form -->
            <ScrollView Grid.Row="0"
                        Padding="12">
                <StackLayout Spacing="10">
                    <Label Text="ðŸ“ Tasks"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>

                    <Entry Placeholder="Task name"
                           Text="{Binding NewTaskName}"
                           PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#666666}"
                           BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>

                    <Editor Placeholder="Description"
                            Text="{Binding NewTaskDescription}"
                            HeightRequest="60"
                            PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#666666}"
                            BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
                            TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>

                    <DatePicker Date="{Binding NewTaskEndDate}"
                                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
                                TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>

                    <Grid ColumnDefinitions="*,Auto"
                          ColumnSpacing="8">
                        <Entry Grid.Column="0"
                               Placeholder="Folder path (attachment)"
                               Text="{Binding NewTaskAttachmentPath}"
                               PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#666666}"
                               BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
                               TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                        <Button Grid.Column="1"
                                Text="ðŸ“"
                                Command="{Binding SetCurrentPathAsAttachmentCommand}"
                                BackgroundColor="#2196F3"
                                TextColor="White"
                                Padding="8"/>
                    </Grid>

                    <Button Text="âž• Add Task"
                            Command="{Binding AddTaskCommand}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            Padding="12,8"/>

                    <BoxView HeightRequest="1"
                             Color="{AppThemeBinding Light=#DDDDDD, Dark=#444444}"
                             Margin="0,10"/>
                </StackLayout>
            </ScrollView>

            <!-- Task List -->
            <CollectionView Grid.Row="1"
                            ItemsSource="{Binding Tasks}"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Stroke="{AppThemeBinding Light=#DDDDDD, Dark=#444444}"
                                StrokeThickness="0,0,0,1"
                                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
                                Padding="12,8"
                                Margin="8,4">
                            <Grid RowDefinitions="Auto,Auto,Auto"
                                  ColumnDefinitions="Auto,*,Auto,Auto"
                                  RowSpacing="4"
                                  ColumnSpacing="8"
                                  Opacity="{Binding IsDone, Converter={StaticResource TaskOpacityConverter}}">

                                <!-- Done Checkbox -->
                                <CheckBox Grid.Row="0"
                                          Grid.Column="0"
                                          Grid.RowSpan="3"
                                          IsChecked="{Binding IsDone}"
                                          Color="#4CAF50"
                                          VerticalOptions="Center"
                                          CheckedChanged="OnTaskCheckBoxChanged"/>

                                <!-- Task Name -->
                                <Label Grid.Row="0"
                                       Grid.Column="1"
                                       Grid.ColumnSpan="3"
                                       Text="{Binding Name}"
                                       FontAttributes="Bold"
                                       FontSize="14"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       TextDecorations="{Binding IsDone, Converter={StaticResource TaskTextDecorationConverter}}"/>

                                <!-- Description -->
                                <Label Grid.Row="1"
                                       Grid.Column="1"
                                       Grid.ColumnSpan="3"
                                       Text="{Binding Description}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                                       TextDecorations="{Binding IsDone, Converter={StaticResource TaskTextDecorationConverter}}"/>

                                <!-- End Date -->
                                <Label Grid.Row="2"
                                       Grid.Column="1"
                                       Text="{Binding EndDate, StringFormat='Due: {0:MM/dd/yyyy}'}"
                                       FontSize="11"
                                       TextColor="{AppThemeBinding Light=#999999, Dark=#888888}"/>

                                <!-- Attachment Button -->
                                <Button Grid.Row="2"
                                        Grid.Column="2"
                                        Text="ðŸ“"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.NavigateToTaskPathCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="Transparent"
                                        TextColor="#2196F3"
                                        Padding="4"
                                        FontSize="14"
                                        IsVisible="{Binding AttachmentPath, Converter={StaticResource InverseBoolConverter}, ConverterParameter='empty'}"/>

                                <!-- Delete Button -->
                                <Button Grid.Row="2"
                                        Grid.Column="3"
                                        Text="ðŸ—‘ï¸"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTaskCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="Transparent"
                                        TextColor="#F44336"
                                        Padding="4"
                                        FontSize="14"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- File Explorer (Right Side) -->
        <Grid Grid.Column="1"
              RowDefinitions="Auto,Auto,*,Auto"
              Padding="0">
            <!-- Current Path Display -->
            <Grid ColumnDefinitions="*,Auto"
                  Padding="12,8"
                  RowSpacing="8"
                  BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}">
                <Label Text="Current Path:"
                       FontAttributes="Bold"
                       VerticalOptions="Center"/>
                <Label Grid.Column="1"
                       Text="{Binding CurrentPath}"
                       FontSize="12"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}"
                       VerticalOptions="Center"
                       LineBreakMode="TailTruncation"/>

                <Grid Grid.Row="1"
                      Grid.ColumnSpan="2"
                      ColumnDefinitions="Auto,Auto,*,Auto,Auto,Auto"
                      ColumnSpacing="8">
                    <Button Text="â—€ Previous"
                            Command="{Binding GoPreviousCommand}"
                            IsEnabled="{Binding CanGoBack}"
                            BackgroundColor="#2196F3"
                            TextColor="White"
                            Padding="12,8"
                            FontSize="13"/>
                    <Button Grid.Column="1"
                            Text="Next â–¶"
                            Command="{Binding GoForwardCommand}"
                            IsEnabled="{Binding CanGoForward}"
                            BackgroundColor="#2196F3"
                            TextColor="White"
                            Padding="12,8"
                            FontSize="13"/>
                    <Button Grid.Column="3"
                            Text="{Binding IsSelectionMode, Converter={StaticResource SelectionModeConverter}}"
                            Command="{Binding ToggleSelectionModeCommand}"
                            BackgroundColor="{Binding IsSelectionMode, Converter={StaticResource SelectionModeColorConverter}}"
                            TextColor="White"
                            Padding="12,8"
                            FontSize="13"/>
                    <Button Grid.Column="4"
                            Text="ðŸ”„ Refresh"
                            Command="{Binding RefreshCommand}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            Padding="12,8"/>
                    <Button Grid.Column="5"
                            Text="â¬† Up"
                            Command="{Binding GoBackCommand}"
                            BackgroundColor="#FF9800"
                            TextColor="White"
                            Padding="12,8"/>
                </Grid>
            </Grid>

            <!-- Create Folder Section -->
            <Grid Grid.Row="1"
                  Padding="12"
                  ColumnDefinitions="*,Auto,Auto"
                  ColumnSpacing="8"
                  BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#252525}">
                <Entry Placeholder="New folder name"
                       Text="{Binding NewFolderName}"
                       PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#666666}"
                       BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                <Button Grid.Column="1"
                        Text="âž• Create"
                        Command="{Binding CreateFolderCommand}"
                        BackgroundColor="#FF5722"
                        TextColor="White"
                        Padding="12,8"/>
                <Button Grid.Column="2"
                        Text="ðŸ—‘ï¸ Delete Selected"
                        Command="{Binding DeleteSelectedCommand}"
                        IsVisible="{Binding IsSelectionMode}"
                        BackgroundColor="#F44336"
                        TextColor="White"
                        Padding="12,8"/>
            </Grid>

            <!-- Loading Indicator -->
            <ActivityIndicator Grid.Row="2"
                               IsRunning="{Binding IsLoading}"
                               IsVisible="{Binding IsLoading}"
                               Color="#2196F3"/>

            <!-- File List -->
            <CollectionView Grid.Row="2"
                            ItemsSource="{Binding Items}"
                            SelectionMode="Single"
                            SelectionChanged="OnCollectionViewSelectionChanged">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border
                            Stroke="{AppThemeBinding Light=#EEEEEE, Dark=#333333}"
                            StrokeThickness="0,0,0,1"
                            BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}">
                            <Grid Padding="12,8"
                                  ColumnDefinitions="Auto,Auto,*,Auto,Auto"
                                  ColumnSpacing="12">

                                <!-- Selection Checkbox (visible in selection mode) -->
                                <CheckBox Grid.Column="0"
                                          IsChecked="{Binding IsSelected}"
                                          IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsSelectionMode}"
                                          Color="#2196F3"
                                          VerticalOptions="Center"
                                          CheckedChanged="OnCheckBoxCheckedChanged"/>

                                <!-- Icon -->
                                <Label Grid.Column="1"
                                       Text="{Binding Icon}"
                                       FontSize="24"
                                       VerticalOptions="Center"/>

                                <!-- Details -->
                                <StackLayout Grid.Column="2"
                                             VerticalOptions="Center"
                                             Spacing="2">
                                    <Label Text="{Binding Name}"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                           FontSize="14"/>
                                    <Grid ColumnDefinitions="Auto,Auto"
                                          ColumnSpacing="12">
                                        <Label Text="{Binding Modified, StringFormat='{0:g}'}"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                                        <Label Grid.Column="1"
                                               Text="{Binding SizeDisplay}"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                                    </Grid>
                                </StackLayout>

                                <!-- Rename Button -->
                                <Button Grid.Column="3"
                                        Text="âœï¸"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RenameCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="Transparent"
                                        TextColor="#2196F3"
                                        Padding="4"
                                        FontSize="16"
                                        IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsSelectionMode, Converter={StaticResource InverseBoolConverter}}"/>

                                <!-- Delete Button -->
                                <Button Grid.Column="4"
                                        Text="ðŸ—‘ï¸"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="Transparent"
                                        TextColor="#F44336"
                                        Padding="4"
                                        FontSize="16"
                                        IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsSelectionMode, Converter={StaticResource InverseBoolConverter}}"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Empty State -->
            <StackLayout Grid.Row="2"
                         VerticalOptions="Center"
                         HorizontalOptions="Center"
                         Spacing="12"
                         IsVisible="{Binding Items.Count, Converter={StaticResource IntToBoolConverter}}">
                <Label Text="ðŸ“­"
                       FontSize="48"
                       HorizontalTextAlignment="Center"/>
                <Label Text="Folder is empty"
                       FontSize="16"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                       HorizontalTextAlignment="Center"/>
            </StackLayout>

        </Grid>
    </Grid>
</ContentPage>
